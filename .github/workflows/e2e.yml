name: e2e

on:
  push:
  pull_request:
    branches: [ master, testing ]
env:
  REGISTRY: 220dfe2ceb39/baremetal-registry
jobs:
  # e2e
  e2e:
    runs-on: ubuntu-20.04
    steps:
    - name: create workflow directory
      run: | 
        mkdir dell
        cd dell/

    - name: Check out code
      uses: actions/checkout@v2

    - name: add operators dir
      run: |
        cd ../
        git clone https://github.com/dell/csi-baremetal-operator.git
        
    - name: add envaroment variables 
      run: |
        export CSI_BAREMETAL_DIR=$HOME/dell/csi-baremetal
        export CSI_BAREMETAL_OPERATOR_DIR=$HOME/dell/csi-baremetal-operator

    - name: LVL2 install
      run: |
        sudo apt-get update
        sudo apt-get install -y lvm2
  
    - name: install gov1.16.8
      run: |
        sudo snap install go --classic 
        echo 'export GOPATH=$HOME/Go' >> $HOME/.bashrc
        source $HOME/.bashrc

    - name: install helm
      run: |
        curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
        sudo apt-get install apt-transport-https --yes
        echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
        sudo apt-get update
        sudo apt-get install helm

    - name: CUSTOM KIND
      run: |
        wget -O kind https://github.com/painhardcore/builder/releases/download/0.0.1-alpha/kind_v0.8.1
        sudo chmod +x kind
        sudo mv kind /usr/bin
          
    - name: Kubectl install
      run: |
        curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
        chmod +x ./kubectl
        sudo mv ./kubectl /usr/local/bin/kubectl
        kubectl version --client 

    - name: add CSI_VERSION
      run: |
        cd ${CSI_BAREMETAL_DIR}
        export CSI_VERSION=`make version`

    - name: Get dependencies
      run: make dependency

    - name: download proto/protoc-gen-go
      run: |
        go get -u github.com/golang/protobuf/{proto,protoc-gen-go}
        echo 'export PATH=$PATH:$GOPATH/bin' >> $HOME/.bashrc
        source $HOME/.bashrc

    - name: whereis protoc-gen-go
      run: |
        realpath protoc-gen-go
        whereis protoc-gen-go
        echo 'export PATH=$PATH:/home/runner/work/csi-baremetal/csi-baremetal' >> $HOME/.bashrc
        source $HOME/.bashrc

    - name: Compile proto files
      run: make install-compile-proto

    - name: Generate CRD
      run: make install-controller-gen 
          
    - name: Deepcopy      
      run:  make generate-deepcopy

    - name: Run unit tests
      run: make test

    - name: Run linting
      run: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.42.1
        make lint

    - name: Clean prev artifacts
      run: make clean

    - name: Build binary
      run: |
        make build
        make DRIVE_MANAGER_TYPE=loopbackmgr build-drivemgr

    - name: Download health-probe
      run: make download-grpc-health-probe

    - name: Build docker images
      run: |
          make images REGISTRY=${{ env.REGISTRY }}
          make DRIVE_MANAGER_TYPE=loopbackmgr image-drivemgr REGISTRY=${{ env.REGISTRY }}

    - name: add CSI_OPERATOR_VERSION
      run: |
        cd ${CSI_BAREMETAL_OPERATOR_DIR}
        export CSI_OPERATOR_VERSION=`make version`

    - name: Linting in operators
      run: make lint
    
    - name: 
      run: |
        make docker-build REGISTRY=${REGISTRY}

    - name: Kind preparation
      run: |
        make kind-build
        make kind-create-cluster
        kubectl cluster-info --context kind-kind
        kubectl get pods -o wide --all-namespaces 
        echo "current-context:" $(kubectl config current-context)
        echo "environment-kubeconfig:" ${KUBECONFIG}

    - name: if some pods is fail 
      run: |
        sudo sysctl net/netfilter/nf_conntrack_max=131072
    
    - name: Sleep for 30 seconds
      uses: jakejarvis/wait-action@master
      with:
        time: '600s'    

    - name: Sidecars preparing
      run: |
        make deps-docker-pull
        make deps-docker-tag

    - name: Retag CSI images and load them to kind
      run: |
          make kind-tag-images TAG=${CSI_VERSION} REGISTRY=${{ env.REGISTRY }}
          make kind-load-images TAG=${CSI_VERSION} REGISTRY=${{ env.REGISTRY }}
          make load-operator-image OPERATOR_VERSION=${CSI_OPERATOR_VERSION} REGISTRY=${{ env.REGISTRY }}
    - name: Make test
      run: make test-ci CSI_VERSION=${CSI_VERSION} OPERATOR_VERSION=${CSI_OPERATOR_VERSION} CHARTS_DIR=${CSI_BAREMETAL_OPERATOR_DIR/charts}
    
    - name: 
      run: |
        sudo apt-get -y install python3-pip
        pip3 install junit2html
        junit2html test/e2e/report.xml e2e_results.html
